<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>New Waffle matcher: expect().to.be.calledOnContract()</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">New Waffle matcher: expect().to.be.calledOnContract()</h1>
</header>
<section data-field="subtitle" class="p-summary">
Perhaps you read my previous post about mocking smart contracts. Now, if you did, you may probably agree that writing tests is still a…
</section>
<section data-field="body" class="e-content">
<section name="ad28" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><figure name="9fda" id="9fda" class="graf graf--figure graf--leading"><img class="graf-image" data-image-id="1*SEuHGmexw_2zxqiAC05u_A.png" data-width="1000" data-height="666" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*SEuHGmexw_2zxqiAC05u_A.png"></figure><h3 name="dc94" id="dc94" class="graf graf--h3 graf-after--figure graf--title">New Waffle matcher: expect().to.be.calledOnContract()</h3><p name="aa3f" id="aa3f" class="graf graf--p graf-after--h3">Perhaps you read my previous post about <a href="https://medium.com/ethworks/mocking-solidity-smart-contracts-with-waffle-55813b22ebf2" data-href="https://medium.com/ethworks/mocking-solidity-smart-contracts-with-waffle-55813b22ebf2" class="markup--anchor markup--p-anchor" target="_blank"><em class="markup--em markup--p-em">mocking smart contracts</em></a><em class="markup--em markup--p-em">. </em>Now, if you did, you may probably agree that writing tests is still a challange. One of the fundamental reasons is that we approach them as if they were integration tests rather than unit tests.</p><p name="8810" id="8810" class="graf graf--p graf-after--p">This time, we are going to focus on another aspect of the same challenge: testing the effects of a call.</p><h3 name="dea5" id="dea5" class="graf graf--h3 graf-after--p">Testing effects</h3><p name="aa30" id="aa30" class="graf graf--p graf-after--h3">Let’s examine once more a testing scenario for a hypothetical ERC721 market that allows trading non-fungible tokens for ERC20 tokens.</p><figure name="4b96" id="4b96" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*LQRfEfTzKQZVIYdpVUyS3A.png" data-width="600" data-height="400" src="https://cdn-images-1.medium.com/max/800/1*LQRfEfTzKQZVIYdpVUyS3A.png"></figure><p name="4e2d" id="4e2d" class="graf graf--p graf-after--figure">Once a call to the <em class="markup--em markup--p-em">contract under test (Market</em> on our diagram<em class="markup--em markup--p-em">) </em>is made, one needs to inspect the effects of the call. We usually do that by querying the state of the related smart contracts. This might be somewhat complex at times, as we need to look into the state of different smart contracts, which in some cases might be private. In other cases, the state might poorly reflect interactions between contracts.</p><p name="d6bc" id="d6bc" class="graf graf--p graf-after--p">Wouldn’t it be useful if we could examine precisely what the interactions between a <em class="markup--em markup--p-em">contract under test</em> and its dependencies are?</p><figure name="a645" id="a645" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*83BoBB6qkY2B2G419p5hlQ.png" data-width="600" data-height="400" src="https://cdn-images-1.medium.com/max/800/1*83BoBB6qkY2B2G419p5hlQ.png"></figure><h3 name="833a" id="833a" class="graf graf--h3 graf-after--figure">expect(…).to.be.calledOnContract(…);</h3><p name="6242" id="6242" class="graf graf--p graf-after--h3">For those complex cases, we’ve introduced a new matcher that allows us to specify expectations as to which function should be called, on which contracts, and with which arguments.</p><p name="d4c1" id="d4c1" class="graf graf--p graf-after--p">Let’s examine an example smart contract.</p><pre name="79a6" id="79a6" class="graf graf--pre graf-after--p">pragma solidity ^0.6.2;<br><br>import &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;<br><br>contract BasicToken is ERC20 {<br>  constructor(uint256 initialBalance) ERC20(&quot;Basic&quot;, &quot;BSC&quot;) public {<br>    _mint(msg.sender, initialBalance);<br>  }<br>}<br><br>contract AmIRichAlready {<br>    BasicToken private tokenContract;<br>    uint private constant RICHNESS = 1000000 * 10 ** 18;<br>    constructor (BasicToken _tokenContract) public {<br>        tokenContract = _tokenContract;<br>    }<br><br>    function check() public view returns (bool) {<br>        uint balance = tokenContract.balanceOf(msg.sender);<br>        return balance &gt; RICHNESS;<br>    }<br>}</pre><p name="7374" id="7374" class="graf graf--p graf-after--pre">Now, with the new matcher, we can test it in the following ways. Firstly, examine if a specific function on the contract was called:</p><pre name="4ca2" id="4ca2" class="graf graf--pre graf-after--p">it(&#39;...&#39;, async () =&gt; {<br>  ...<br>  await contract.check();<br>  expect(&#39;balanceOf&#39;).to.be.calledOnContract(ERC20);<br>});</pre><p name="4a9e" id="4a9e" class="graf graf--p graf-after--pre">Secondly, specify exact parameters to be used in the call:</p><pre name="2c73" id="2c73" class="graf graf--pre graf-after--p">it(&#39;...&#39;, async () =&gt; {<br>  ...<br>  await contract.check();<br>  expect(&#39;balanceOf&#39;).to.be<br>    .calledOnContractWith(ERC20, [wallet.address]);<br>});</pre><p name="198b" id="198b" class="graf graf--p graf-after--pre">Full example <a href="https://github.com/EthWorks/Waffle/tree/master/examples/called-on-contract" data-href="https://github.com/EthWorks/Waffle/tree/master/examples/called-on-contract" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">available here</a>.</p><h3 name="b4d0" id="b4d0" class="graf graf--h3 graf-after--p">Works with Mock and… any contract</h3><p name="ba35" id="ba35" class="graf graf--p graf-after--h3">And here is the best part. The new matchers work with both normal and mock contracts described in the previous post. It is because Waffle records and filters EVM calls rather than inject code, like it is the case of popular testing libraries for other technologies.</p><h3 name="f107" id="f107" class="graf graf--h3 graf-after--p">Important notes</h3><p name="7518" id="7518" class="graf graf--p graf-after--h3">This feature was introduced in Waffle version 2.5.</p><p name="0d60" id="0d60" class="graf graf--p graf-after--p graf--trailing">Currently, it doesn’t work with <em class="markup--em markup--p-em">Buidler </em>which some of you are using together Waffle. However, we’ll be working with the Nomic Labs team in the following weeks to integrate the matchers into the framework.</p></div></div></section><section name="bae0" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="caff" id="caff" class="graf graf--p graf--leading">We are <a href="https://ethworks.io/" data-href="https://ethworks.io/" class="markup--anchor markup--p-anchor" rel="noopener nofollow noopener" target="_blank">Ethworks</a>. A truly remarkable team for your blockchain project.</p><p name="629f" id="629f" class="graf graf--p graf-after--p graf--trailing">Find us on <a href="https://twitter.com/ethworks" data-href="https://twitter.com/ethworks" class="markup--anchor markup--p-anchor" rel="noopener nofollow noopener" target="_blank">Twitter</a>, <a href="https://dribbble.com/ethworks" data-href="https://dribbble.com/ethworks" class="markup--anchor markup--p-anchor" rel="noopener nofollow noopener" target="_blank">Dribbble</a> and <a href="https://github.com/ethworks" data-href="https://github.com/ethworks" class="markup--anchor markup--p-anchor" rel="noopener nofollow noopener" target="_blank">GitHub</a>.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@marekkirejczyk" class="p-author h-card">Marek Kirejczyk</a> on <a href="https://medium.com/p/50dbd2a71a78"><time class="dt-published" datetime="2020-06-03T14:43:49.485Z">June 3, 2020</time></a>.</p><p><a href="https://medium.com/@marekkirejczyk/new-waffle-matcher-expect-to-be-calledoncontract-50dbd2a71a78" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on September 22, 2025.</p></footer></article></body></html>