<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Preventing billion-dollar hacks</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Preventing billion-dollar hacks</h1>
</header>
<section data-field="subtitle" class="p-summary">
This is the first in a series of blog posts about the process for rapid dapp development on blockchain:
Part 1: Security‚Ää‚Äî‚ÄäPreventing‚Ä¶
</section>
<section data-field="body" class="e-content">
<section name="e1ad" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><figure name="9137" id="9137" class="graf graf--figure graf--leading"><img class="graf-image" data-image-id="1*3US2VvpS0PrTmJso7z6vhg.jpeg" data-width="1200" data-height="639" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*3US2VvpS0PrTmJso7z6vhg.jpeg"></figure><h3 name="6ccb" id="6ccb" class="graf graf--h3 graf-after--figure graf--title">Preventing billion-dollar hacks</h3><p name="87bc" id="87bc" class="graf graf--p graf-after--h3">This is the first in a <strong class="markup--strong markup--p-strong">series</strong> of blog posts about the process for rapid dapp development on blockchain:<br><strong class="markup--strong markup--p-strong">Part 1</strong>: Security‚Ää‚Äî‚ÄäPreventing billion-dollar hacks<br><strong class="markup--strong markup--p-strong">Part 2</strong>: Releasing‚Ää‚Äî‚ÄäContinuous delivery on the blockchain (coming soon)<br><strong class="markup--strong markup--p-strong">Part 3</strong>: Team scaling‚Ää‚Äî‚ÄäAgile blockchain development at scale (coming soon)</p><h3 name="af82" id="af82" class="graf graf--h3 graf-after--p">A billion-dollar question</h3><p name="709f" id="709f" class="graf graf--p graf-after--h3">Major hacks happen in blockchain all the time. And yet, every time the news reaches us, it sparks fiery debates in our community over again.<br>This leaves blockchain engineering teams with one important question:</p><blockquote name="348f" id="348f" class="graf graf--blockquote graf-after--p">How to prevent a multimillion-dollar hack in the first place?</blockquote><h4 name="bcae" id="bcae" class="graf graf--h4 graf-after--blockquote">Fundamental questions</h4><p name="c1f4" id="c1f4" class="graf graf--p graf-after--h4">Faced with this exact question, we designed a process to reduce the probability of a hack to the lowest possible. We were heavily inspired by other top teams in the industry, but also added some significant improvements.</p><p name="0bdf" id="0bdf" class="graf graf--p graf-after--p">We started by asking a few fundamental questions, like:</p><ul class="postList"><li name="842d" id="842d" class="graf graf--li graf-after--p">How to reduce the risk to fractional?</li><li name="11e1" id="11e1" class="graf graf--li graf-after--li">What are the essential tools we can use to build a security process?</li><li name="088f" id="088f" class="graf graf--li graf-after--li">How can we combine them to achieve the best outcome?</li><li name="d288" id="d288" class="graf graf--li graf-after--li">How to measure our performance?</li></ul><p name="bb0f" id="bb0f" class="graf graf--p graf-after--li">We will answer them in this post. Let‚Äôs start with the tools and later we‚Äôll look into the process.</p><h3 name="fed4" id="fed4" class="graf graf--h3 graf-after--p">Tools</h3><p name="a461" id="a461" class="graf graf--p graf-after--h3">What are the essential tools for security, aside from hiring top engineers and exhaustive testing? We all know about bug bounties and external audits. Most are aware of formal verification and phasing as well.</p><figure name="4b26" id="4b26" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*67uAkbUmGDiXTOfsGR028w.jpeg" data-width="1200" data-height="675" src="https://cdn-images-1.medium.com/max/800/1*67uAkbUmGDiXTOfsGR028w.jpeg"></figure><p name="61a2" id="61a2" class="graf graf--p graf-after--figure">Is there anything else?</p><p name="07d2" id="07d2" class="graf graf--p graf-after--p">There is. Here are some less mentioned practices: <em class="markup--em markup--p-em">defect injection</em>, which can be used in combination with <em class="markup--em markup--p-em">benchmarking</em> and <em class="markup--em markup--p-em">capture-recapture</em>, <em class="markup--em markup--p-em">incremental roll-out</em> and splitting security responsibilities between the <em class="markup--em markup--p-em">red team</em> and the <em class="markup--em markup--p-em">blue team</em>.</p><h4 name="d856" id="d856" class="graf graf--h4 graf-after--p"><strong class="markup--strong markup--h4-strong">üßÆ Formal verification</strong></h4><p name="416a" id="416a" class="graf graf--p graf-after--h4">For those who are not familiar, here is a perhaps oversimplified explanation. Formal verification is a process of writing a formal specification/formal specifications which can be then automatically verified.</p><p name="674f" id="674f" class="graf graf--p graf-after--p">Unlike tests, formal specifications allow us to make general statements.¬†<br>With <strong class="markup--strong markup--p-strong">tests</strong> you can say:</p><blockquote name="7b34" id="7b34" class="graf graf--blockquote graf-after--p">If I <strong class="markup--strong markup--blockquote-strong">transfer</strong> <strong class="markup--strong markup--blockquote-strong">5 tokens</strong> to another person, then the beneficiary will <strong class="markup--strong markup--blockquote-strong">get 5 tokens</strong>.</blockquote><p name="3adf" id="3adf" class="graf graf--p graf-after--blockquote">With a <strong class="markup--strong markup--p-strong">formal specification</strong> you can say:</p><blockquote name="3c22" id="3c22" class="graf graf--blockquote graf-after--p">If I transfer <strong class="markup--strong markup--blockquote-strong">any non-negative amount of tokens</strong> to another person, then the beneficiary‚Äôs account <strong class="markup--strong markup--blockquote-strong">balance will increase by the exact same amount</strong>.</blockquote><p name="db78" id="db78" class="graf graf--p graf-after--blockquote">And it will take care of all edge cases like underflows, overflows, sending to yourself, etc</p><p name="d2a7" id="d2a7" class="graf graf--p graf-after--p">The tools got better over time and now, with <a href="https://www.certora.com/" data-href="https://www.certora.com/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Certora</a>, we can run a verification after each commit. Before this, verification of somewhat complex code used to take hours or days.</p><h4 name="5e34" id="5e34" class="graf graf--h4 graf-after--p">üêû <strong class="markup--strong markup--h4-strong">Defects injecting</strong></h4><p name="fec7" id="fec7" class="graf graf--p graf-after--h4">A great, often overlooked technique to measure the quality of your security process is to inject defects and see how many of them will pass through the security process.</p><p name="12e8" id="12e8" class="graf graf--p graf-after--p">A great <strong class="markup--strong markup--p-strong">source of defects is the code review</strong> process‚Ää‚Äî‚Ääinstead of fixing bugs, we often commit them to a repository. The decision on whether to fix a bug or pass it through is done on a per case basis.</p><p name="e1c7" id="e1c7" class="graf graf--p graf-after--p">To make sure all defects get fixed, we make sure they all land in a <strong class="markup--strong markup--p-strong">hidden registry</strong>. The registry is kept secret from auditors and the <em class="markup--em markup--p-em">red team</em>.¬†<br>It does requires a bit of discipline to ensure it is always up-to-date.</p><p name="befe" id="befe" class="graf graf--p graf-after--p">Each defect is described and the <strong class="markup--strong markup--p-strong">description is hashed</strong>. We publish hashes, so that once the defect is found, it can be clearly stated if it was injected or not.</p><h4 name="a2d6" id="a2d6" class="graf graf--h4 graf-after--p"><strong class="markup--strong markup--h4-strong">üèÜ Benchmarking</strong></h4><p name="8829" id="8829" class="graf graf--p graf-after--h4">Once the audit phase is done, it is easy to compare methods against each other and figure out which methods have a potential to improve, simply by looking at how many defects were found by each method.</p><p name="af15" id="af15" class="graf graf--p graf-after--p">For example:</p><blockquote name="e718" id="e718" class="graf graf--blockquote graf-after--p">Imagine a situation where no (significant) bugs are found.¬†<br>Did the team avoid making any bugs?¬†<br>Or did the auditors do a poor job?¬†<br>With injected bugs it is pretty easy to assess.</blockquote><h4 name="13ed" id="13ed" class="graf graf--h4 graf-after--blockquote"><strong class="markup--strong markup--h4-strong">üï∏ Capture‚Ää‚Äî‚Äärecapture</strong></h4><p name="70f5" id="70f5" class="graf graf--p graf-after--h4">Capture recapture is a simple statistical method that allows to estimate the amount of defects that remained undetected.</p><blockquote name="4bcf" id="4bcf" class="graf graf--blockquote graf-after--p">In principle, if all methods found the same defect, the chances are that the majority were captured. If, on the other hand, all of them found different defects, there is a high probability there are some left unfound.</blockquote><p name="3b41" id="3b41" class="graf graf--p graf-after--blockquote">In practice it requires a bit of statistic. The method comes from ecology where it is used to estimate an animal population‚Äôs size. Take results with a grain of salt, however high estimation on undetected bugs should be clear indicator to do additional audits.</p><h4 name="26d9" id="26d9" class="graf graf--h4 graf-after--p"><strong class="markup--strong markup--h4-strong">üé¢ Incremental roll-out</strong></h4><p name="51c7" id="51c7" class="graf graf--p graf-after--h4">Finally, rollout to production plays a crucial role in security. We avoid upgrading smart contracts as much as possible. Instead, we deploy new versions of smart contracts (i.e. new pools and portfolios) and allow money to pour slowly into them while the bug bounty is already running.</p><p name="9e73" id="9e73" class="graf graf--p graf-after--p">An incremental roll-out also means an <strong class="markup--strong markup--p-strong">incremental phase-out</strong>. To avoid maintaining a big number of pools and huge codebase, we want to make sure that old pools are phased out and slowly taken over by new pools.</p><h4 name="2383" id="2383" class="graf graf--h4 graf-after--p"><strong class="markup--strong markup--h4-strong">üëÆ‚Äç‚ôÇÔ∏è Red¬†team</strong></h4><p name="d4b2" id="d4b2" class="graf graf--p graf-after--h4">Internally, we created a security team inspired by the ‚Äú<em class="markup--em markup--p-em">red team</em>‚Ää‚Äî‚Ää<em class="markup--em markup--p-em">blue team</em>‚Äù practice. The red team‚Äôs job is to find defects in the smart contract code. Their main tool for the job is formal verification. As they try to write automatic proofs of correctness of the code, this often leads to finding subtle bugs that would be difficult to find with naked eye.</p><p name="2948" id="2948" class="graf graf--p graf-after--p">Red team is involved in the design phase as well. Therefore the boundary of the <em class="markup--em markup--p-em">red team</em> is a little blurry here.</p><h4 name="cf2f" id="cf2f" class="graf graf--h4 graf-after--p">üìñ <strong class="markup--strong markup--h4-strong">Transparency</strong></h4><p name="5586" id="5586" class="graf graf--p graf-after--h4">Below is an image with a diagram showing the results of different methods on our first full iteration of this process at TrueFi. We will also publish detailed post soon, with much more down-to-earth perspective than this one. For transparency, we will keep publishing blog posts after each iteration.</p><figure name="bdec" id="bdec" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*QlwbHYjmsM-Q9o6NbdpCRQ.jpeg" data-width="1200" data-height="675" src="https://cdn-images-1.medium.com/max/800/1*QlwbHYjmsM-Q9o6NbdpCRQ.jpeg"></figure><h3 name="18fb" id="18fb" class="graf graf--h3 graf-after--figure">The process</h3><p name="1ca0" id="1ca0" class="graf graf--p graf-after--h3">Now we can explore how all the different techniques combine into our process. First, take a look at the illustration below to get the general idea and follow with description for each phase.</p><figure name="4fca" id="4fca" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*-trf_U9uKjI-lwK06WjvKA.jpeg" data-width="1200" data-height="865" src="https://cdn-images-1.medium.com/max/800/1*-trf_U9uKjI-lwK06WjvKA.jpeg"></figure><h4 name="236a" id="236a" class="graf graf--h4 graf-after--figure">üë®‚Äçüíª Phase 1: Development</h4><p name="480e" id="480e" class="graf graf--p graf-after--h4">We start with development of smart contracts and if we encounter defects in the process, we keep them in the code, but add them into a <strong class="markup--strong markup--p-strong">secret registry</strong>. Also formal verification team gets a head start writing formal specification.</p><h4 name="cf1a" id="cf1a" class="graf graf--h4 graf-after--p">üîé Phase 2:¬†Audit</h4><p name="3e0f" id="3e0f" class="graf graf--p graf-after--h4">In this phase:</p><ol class="postList"><li name="8ec4" id="8ec4" class="graf graf--li graf-after--p">We <strong class="markup--strong markup--li-strong">publish the source code</strong> in a separate repository, but don‚Äôt reveal tests or specifications, as it might hint at injected defects.</li><li name="a89c" id="a89c" class="graf graf--li graf-after--li">The security team is working full speed ahead on <strong class="markup--strong markup--li-strong">formal specifications</strong></li><li name="72d1" id="72d1" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Two external audits</strong> are being performed</li><li name="a5d7" id="a5d7" class="graf graf--li graf-after--li">We set up a <strong class="markup--strong markup--li-strong">‚Äúsmall‚Äù bug bounty</strong> on Gitcoin and we pay for every found bug. If the bug was injected, the payout is small, but if it wasn‚Äôt, then the payout is significant.</li></ol><h4 name="5aa5" id="5aa5" class="graf graf--h4 graf-after--li">üè≠ Phase 3:¬†Review</h4><p name="7eee" id="7eee" class="graf graf--p graf-after--h4">In this phase we review results:</p><ol class="postList"><li name="d22f" id="d22f" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">Benchmark</strong> four methods (two audits, formal verification, bug bounty)</li><li name="7a99" id="7a99" class="graf graf--li graf-after--li">Perform <strong class="markup--strong markup--li-strong">capture-recapture</strong> calculations</li><li name="5ad6" id="5ad6" class="graf graf--li graf-after--li">Based on above, we <strong class="markup--strong markup--li-strong">generate improvements</strong> in our process and in collaboration with external parties.</li><li name="f3f5" id="f3f5" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">We fix the bugs </strong>from secret repository and wait for a re-audit results.</li><li name="f467" id="f467" class="graf graf--li graf-after--li">We <strong class="markup--strong markup--li-strong">publish</strong> <strong class="markup--strong markup--li-strong">tests and specifications </strong>in a public repository</li></ol><p name="e3cb" id="e3cb" class="graf graf--p graf-after--li">And if we are confident, we can proceed to the next step.</p><h4 name="1edc" id="1edc" class="graf graf--h4 graf-after--p">üè≠ Phase 4: Production</h4><p name="1dc5" id="1dc5" class="graf graf--p graf-after--h4">Finally, we deploy contracts to production and the money slowly starts getting into contracts. We publish a <a href="https://immunefi.com/bounty/truefi/" data-href="https://immunefi.com/bounty/truefi/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">‚Äúbig‚Äù</strong> <strong class="markup--strong markup--p-strong">bug bounty</strong></a> on Immunify, with a $100k reward for a critical bug, which we plan to increase over time to $1mln per critical bug.</p><h3 name="7ee2" id="7ee2" class="graf graf--h3 graf-after--p">üìÖ Scheduling</h3><p name="2000" id="2000" class="graf graf--p graf-after--h3">The process requires certain discipline, not only to keep the defect registry secret and always up-to-date, but also in regard to scheduling.¬†<br>We are currently releasing smart contracts every two months. The code includes 2‚Äì3 sub products (i.e new pools, governance update, etc).</p><p name="6437" id="6437" class="graf graf--p graf-after--p">Ideally, both audits start and finish at the same or at least at a similar time. Which is challenging as they need to be scheduled months in advance and usually auditors want to start with a precision of a single day.</p><p name="9655" id="9655" class="graf graf--p graf-after--p">Hence a lot of effort goes into planning and getting things done within a given time window and sticking to it.</p><h3 name="02d6" id="02d6" class="graf graf--h3 graf-after--p">Summary</h3><p name="d051" id="d051" class="graf graf--p graf-after--h3 graf--trailing">The process which I described gives us high level confidence in the code and helps us sleep at night. However, security is an ongoing challenge and we strive for perfection by improving both the process and our skills. We will keep you updated.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@marekkirejczyk" class="p-author h-card">Marek Kirejczyk</a> on <a href="https://medium.com/p/403d7bffac75"><time class="dt-published" datetime="2022-03-31T08:26:37.891Z">March 31, 2022</time></a>.</p><p><a href="https://medium.com/@marekkirejczyk/preventing-billion-dollar-hacks-403d7bffac75" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on September 22, 2025.</p></footer></article></body></html>